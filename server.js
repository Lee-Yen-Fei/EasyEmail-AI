const express = require('express');
const dotenv = require('dotenv');
const generateText = require('./generate_text');
const getAccessToken = require('./generate_token'); // Import the function to get the token

dotenv.config();

const app = express();

app.set('view engine', 'ejs');
app.use(express.urlencoded({ extended: true }));
app.use(express.static('public'));

app.get('/', (req, res) => {
  res.render('index', { generatedEmail: null });
});

app.post('/generate', async (req, res) => {
  const { recipientName, senderName, subject, keyPoints } = req.body;

  console.log('Received form data:', req.body);

  const prompt = `
    "Given the purpose and key points of an email, write the email in a polite and friendly way, depending on the context, be professional. Briefly elaborate on the reason for the letter and depending on necessity, explain any actions that will be taken. Highlight the key points using double asterisks. Identify the relationship between the writer and the recipient. For example, an absence letter indicates the recipient is either a higher-up or a client of the writer. Don'\''t add places if it'\''s not provided in key points.\n\nInput: recipientName: '\''Kwek Yong Jing'\''\nsubject: '\''training days absence'\''\nkeypoints: '\''14th & 15th November 2023'\'', '\''accept offer to join organization, due to local reelection, catch up'\''\nsenderName: '\''Lee Yen Fei\nOutput: Subject: Possible Absence on Upcoming Training Days\n\nDear Kwek Yong Jing,\n\nThank you for the offer to join the {ORGANIZATION_NAME}. I am excited about the opportunity and would like to ACCEPT the position.\n\nHowever, I have a potential **scheduling conflict** due to a local re-election in my district, which affects my ability to attend the training sessions on 14th & 15th November 2023. I will need to return home to vote and may face transportation challenges.\n\nCould you please provide the time range for the training sessions? Additionally, I would appreciate it if you could share the key topics or materials that will be covered during these sessions so I can catch up on any missed information.\n\nThank you for your understanding, and I look forward to contributing to the team.\n\nBest regards,\nLee Yen Fei\n\nInput: recipientName: '\''Mr Smith'\''\nsubject: '\''absence letter advanced calculus class'\''\nkeypoints: '\''24th May 2024, \nparticipation in a hackathon'\''\nsenderName: Joan\nOutput: Subject: Absence from Advanced Calculus Class on 24th May 2024\n\nDear Mr Smith,\n\nI hope this message finds you well. I am writing to inform you that I will be unable to attend the Advanced Calculus class on the 24th of May 2024 due to my participation in a hackathon event.\n\nI apologize for any inconvenience my absence may cause and will ensure that I catch up on any missed material. If there are any specific topics or assignments I should be aware of, please let me know.\n\nThanks for your understanding.\n\nBest regards,\nJoan\n[Your Student ID]\n[Your Contact Information]\n\nInput: recipientName: '\''Mrs Amber'\''\nsubject: '\''sponsorship e-sports valorant tournament'\''\nkeypoints: '\''promote e-sports teamwork, funds for prizes, popular game great exposure, seeking RM 5k'\''\nsenderName: '\''Abu bin Ali'\''\nOutput: Subject: Sponsorship for E-Sports Valorant Tournament\n\nDear Mrs Amber,\n\nI hope this message finds you well. I am reaching out to explore potential sponsorship opportunities for our upcoming E-Sports Valorant Tournament. Our goal is to promote e-sports and highlight the importance of teamwork among participants.\n\nWe are seeking RM 5,000 in sponsorship to support prize funds for the tournament. Valorant is a popular game with a significant following, offering excellent exposure for our sponsors. Your support would not only enhance the event but also provide valuable visibility for your brand within the gaming community.\n\nTournament details are as follows:\nName: [NAME]\nDate: [DATE]\nVenue / Platform: [PLATFORM]\n\nWe would be delighted to discuss this opportunity further and explore how we can collaborate. Please let me know if you are interested or if you require any additional information.\n\nThank you for considering our request.\n\nBest regards,\nAbu bin Ali\n[Your Position/Role]\n[Your Contact Information]\n\nInput: recipientName: '\''Mr Umar'\''\nsubject: '\''inquiry new marketing software'\''\nkeypoints: '\''new marketing software, pricing features support'\''\nsenderName: '\''Zara'\''\nOutput: Subject: Inquiry About New Marketing Software\n\nDear Mr Umar,\n\nI am writing to inquire about your new marketing software solution. Could you please provide detailed information on pricing, features, and the support included with the software?\n\nThank you for your assistance.\n\nBest regards,\nZara\n[Your Position/Title]\n[Your Contact Information]\n\nInput: recipientName: '\''Taj'\''\nsubject: '\''application marketing manager position'\''\nkeypoints: '\''experience in digital marketing team leadership, confident in my ability'\''\nsenderName: '\''Tau'\''\nOutput: Subject: Application for Marketing Manager Position\n\nDear Taj,\n\nI am excited to apply for the Marketing Manager position at [Company Name]. With my extensive experience in digital marketing and team leadership, I am confident in my ability to drive successful campaigns and contribute to your company'\''s growth. Attached is my resume for your review.\n\nThank you for considering my application.\n\nSincerely,\nTau\n[Your Contact Information]\n\nInput: recipientName: '\''Siti'\''\nsubject: '\''complaint regarding defective product'\''\nkeypoints: '\''bought 24th May 2024, only worked 1 week, replacement refund'\''\nsenderName: '\''Hanis'\''\nOutput: Subject: Complaint Regarding Defective Product\n\nDear Siti,\n\nI am writing to express my dissatisfaction with the smartwatch I purchased on 24th May 2024. The device has stopped working after only a week of use. I would appreciate it if you could address this matter by arranging a replacement or providing a refund.\n\nThank you for your attention to this issue.\n\nSincerely,\nHanis\n[Your Contact Information]\n\nInput: recipientName: '\''Elaine'\''\nsubject: '\''recommendation LEE YEN FEI'\''\nkeypoints: '\''he, master’s program in environmental science, worked together on research, good at data analysis project management'\''\nsenderName: '\''Bob'\''\nOutput: Subject: Recommendation for LEE YEN FEI\n\nDear Elaine,\n\nI am pleased to recommend LEE YEN FEI for the Master’s program in Environmental Science at your esteemed institution. During our time working together on several research projects, he demonstrated exceptional skills in data analysis and project management. he would be a valuable addition to your program.\n\nBest regards,\nBob\n[Your Position/Title]\n[Your Contact Information]\n\nInput: recipientName: '\''Evan'\''\nsubject: '\''information on new product launch'\''\nkeypoints: '\''scheduled next quarter, new features, offers'\''\nsenderName: '\''Lia'\''\nOutput: Subject: Request for Information on New Product Launch\n\nDear Evan,\n\nI am seeking information regarding your upcoming product launch scheduled for next quarter. Could you provide details on the new features and any promotional offers that will be available?\n\nThank you.\n\nSincerely,\nLia\n[Your Contact Information]\n\nInput: recipientName: '\''Joey'\''\nsubject: '\''catching up'\''\nkeypoints: '\''share japan trip, visit kyoto tokyo'\''\nsender Name: '\''Joe'\''\nOutput: Catching Up\n\nDear Joey,\n\nI hope you’re doing well! I wanted to update you on my recent trip to Japan. It was an amazing experience, and I visited some beautiful places like Kyoto and Tokyo. Can’t wait to catch up and share more about it with you!\n\nBest,\nJoe\n\nInput: recipientName: '\''Don'\''\nsubject: '\''thanks for the birthday gift'\''\nkeypoints: '\''tablet, use to read watch vids'\''\nsenderName: '\''Amy'\''\nOutput: Thank You for the Birthday Gift\n\nDear Don,\n\nThank you so much for the wonderful birthday gift! The new tablet is perfect, and I’m already using it to read and watch videos. Your thoughtfulness is greatly appreciated.\n\nWarm regards,\nAmy\n\nInput: recipientName: '\''Lee'\''\nsubject: '\''apology missing birthday party'\''\nkeypoints: '\''last weekend, sudden work'\''\nsenderName: '\''Mia'\''\nOutput: Apology for Missing Your Birthday Party\n\nDear Osas,\n\nI am writing to apologize for missing your birthday party last weekend. I had an unexpected work commitment that I couldn’t reschedule. I hope you had a fantastic celebration, and I look forward to catching up soon.\n\nSincerely,\nMia\n\nInput: recipientName: '\''Kat'\''\nsubject: '\''invitation to graduation party'\''\nkeypoints: '\''1st December 2026 8pm, my house'\''\nsenderName: '\''Liz'\''\nOutput: Invitation to My Graduation Party\n\nDear Kat,\n\nI would like to invite you to my graduation party on 1st December 2026 at 8pm, which will be held at my house. It would be great to celebrate this milestone with you. Please let me know if you can make it!\n\nBest regards,\nLiz\n\nInput: recipientName: '\''Jon'\''\nsubject: '\''recent meeting'\''\nkeypoints: '\''project collaboration, updates actions'\''\nsenderName: Dan\nOutput: Follow-Up on Our Recent Meeting\n\nDear Jon,\n\nI am following up on our recent meeting regarding the upcoming project collaboration. I wanted to see if there have been any updates or if there are any additional actions required from my side.\n\nThank you for your time.\n\nBest,\nDan\n\nInput: subject: '\''application acknowledgement'\''\nkeypoints: '\''micron summer internship programme, currently reviewing, updates soon'\''\nOutput: Subject: Micron Summer Internship Programme - Application Acknowledgement\n\nDear [Recipient'\''s Name],\n\nI am writing to acknowledge receipt of your application for the Micron Summer Internship Programme. We are currently reviewing all applications and will be in touch soon regarding the next steps.\n\nThank you for applying.\n\nSincerely,\n[Your Full Name]\n\nInput: subject: '\''confirm appointment'\''\nkeypoints: '\''16th September 2010 6pm, discuss project proposal'\''\nOutput: Subject: Confirmation of Appointment on 16th September 2010\n\nDear [Recipient'\''s Name],\n\nThis letter is to confirm our appointment on 16th September 2010 at 6pm to discuss the project proposal. Please let me know if you need any additional information or if there are any changes to the schedule.\n\nThank you.\n\nBest regards,\n[Your Full Name]\n\nInput: recipientName: '\''Ali'\''\nsubject: '\''feedback training workshop'\''\nkeypoints: '\''last week, informative engaging, be more interactive'\''\nsenderName: '\''Muhamad'\''\nOutput: Subject: Feedback on Recent Electronics Training Workshop\n\nDear Ali,\n\nI wanted to provide feedback on the training workshop held last week. The session was informative and engaging, although more interactive elements would enhance the learning experience. Overall, it was a valuable workshop.\n\nBest regards,\nMuhamad\n\nInput: recipientName: '\''Jim'\''\nsubject: '\''resign as treasurer'\''\nkeypoints: '\''7th July 2019, BYIC'\''\nsenderName: '\''Tim'\''\nOutput: Subject: Resignation as Treasurer for BYIC\n\nDear Jim,\n\nI am writing to formally resign from my position as Treasurer at BYIC, effective 7th July 2019. I appreciate the opportunities I have had during my tenure and will ensure a smooth transition of my responsibilities.\n\nThank you for your support.\n\nSincerely,\nTim\n\nInput: recipientName: '\''Ciel'\''\nsubject: '\''absence request'\''\nkeypoints: '\''11th - 15th July 2007, covid'\''\nsenderName: '\''Ali'\''\nOutput: Subject: Leave of Absence Request\n\nDear Ciel,\n\nI am requesting a leave of absence from 11th to 15th July 2007 due to being diagnosed with the COVID-19. I will ensure that my duties are covered during this period and will be available via email if needed.\n\nThank you.\n\nBest regards,\nAli\n\nInput: recipientName: '\''Ava'\''\nsubject: '\''reference letter'\''\nkeypoints: '\''SANA MINATOZAKI, good project management skills work ethic'\''\nsenderName: '\''Xi Jing Ping'\''\nOutput: Subject: Reference for SANA MINATOZAKI\n\nDear Ava,\n\nI am pleased to provide a reference for SANA MINATOZAKI. During his time at our organization, SANA MINATOZAKI demonstrated excellent project management skills and a strong work ethic. She will be a great asset to any team.\n\nSincerely,\nXi Jing Ping\n[Your Position/Title]\n\nInput: recipientName: '\''Vladimir Putin'\''\nsubject: '\''req property tax info'\''\nkeypoints: '\''my residence, current tax rate any exemptions'\''\nsenderName: '\''Donald Trump'\''\nOutput: Subject: Request for Property Tax Information\n\nDear Vladimir Putin,\n\nI am writing regarding the property tax assessment for my residence at [Address]. Could you please provide information on the current tax rate and any available exemptions?\n\nThank you for your assistance.\n\nSincerely,\nDonald Trump\n\nInput: recipientName: '\''Joe Biden'\''\nsubject: '\''eco-friendly product line launch'\''\nkeypoints: '\''feature sustainable materials, reducing environmental impact, 012-3456789'\''\nsenderName: '\''Kamala Harris'\''\nOutput: Subject: Launch of New Eco-Friendly Product Line\n\nDear Joe Biden,\n\nWe are excited to announce the launch of our new eco-friendly product line. The products feature sustainable materials and innovative designs aimed at reducing environmental impact. For more information, please contact us at 012-3456789.\n\nBest regards,\nKamala Harris\n[Your Position/Organization]\n\nInput: recipientName: '\''Osas'\''\nsubject: '\''congrat promo'\''\nkeypoints: '\''good job'\''\nsenderName: '\''Mia'\''\nOutput: Subject: Congratulations on Your Promotion!\n\nDear Osas,\n\nCongratulations on your recent promotion to [New Position]! This is a well-deserved achievement, and I’m thrilled for you. Wishing you continued success and many more accomplishments in your new role.\n\nBest wishes,\nMia\n\nInput: recipientName: '\''Ande'\''\nsubject: '\''passed away'\''\nkeypoints: '\''ode, family'\''\nsenderName: '\''Ige'\''\nOutput: Subject: Heartfelt Condolences\n\nDear Ande,\n\nI was deeply saddened to hear about Ode’s passing. Please accept my heartfelt condolences during this difficult time. My thoughts are with you and your family.\n\nSincerely,\nIge\n\nInput: recipientName: '\''Bayo'\''\nsubject: '\''new year'\''\nkeypoints: '\''wish’\nsenderName: '\''Saad'\''\nOutput: Subject: Happy Holidays!\n\nDear Bayo,\n\nWishing you a joyful holiday season filled with peace and happiness. May the New Year bring you health, success, and many wonderful moments.\n\nWarm regards,\nSaad

    Input:
    recipientName: ${recipientName}
    subject: ${subject}
    keypoints: ${keyPoints}
    senderName: ${senderName}
    Output:
  `;

  try {
    const accessToken = await getAccessToken(); // Get the access token
    const generatedEmail = await generateText(prompt, accessToken); // Pass the token to generateText
    console.log('Generated email:', generatedEmail);
    res.render('index', { generatedEmail });
  } catch (error) {
    console.error('Error generating email:', error.message);
    res.render('index', { generatedEmail: 'Error generating email, please try again.' });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
